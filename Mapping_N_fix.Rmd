---
title: "Mapping Nitrogen Fixation Globally"
author: "Russell Dinnage and Anna Simonsen"
date: "06/08/2014"
output: html_document
---

```{r knitr_init, echo=FALSE, results="asis", cache=FALSE}
library(knitr)

## Global options
options(max.print="75")
opts_chunk$set(fig.path="out/",
               echo=TRUE,
         cache=TRUE,
               cache.path="cache/",
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

In this document, we will create a global map, with gridded values representing the proportion of occurring legume species that are nitrogen fixing. First we load the global occurrence data and then create a an overlaying grid, which we can use to aggregate the occurrence data over. Here, we use a mixture of spatial analysis functions from the `sp` package and data.frame manipulation functions of `dply` (to speed up calculations).

```{r grid_it}
library(GlobalNfix)
library(sp)
library(maps)
library(mapdata)
library(maptools)
library(rgdal)
library(ggplot2)
library(dplyr)
library(magrittr)
data(full_legume_data)
## convert to spatial object
## create grid of 5 degrees across globe (we can try other grid sizes as well)
grid <- GridTopology(c(-87.5, -177.5), c(5, 5), c(36, 72))
sp_grid <- coordinates(grid) 
sp_grid <- sp_grid %>% 
  data.frame %>% 
  set_names(c("lat_centre", "long_centre")) %>% 
  mutate(grid_id = seq_len(nrow(sp_grid)))
## assign points to grid
sp_grid_assign <- getGridIndex(cc = full_legume_data %>% 
                                   select(decimalLatitude, decimalLongitude) %>%
                                   data.frame,
                                 grid = grid, all.inside = FALSE)
legume_grid <- full_legume_data %>%
  mutate(grid_id = sp_grid_assign) %>%
  left_join(sp_grid)
```

Now that we have that, we can use `dplyr` to calculate the proportion of nitrogen fixing and non-fixing legumes in each grid-cell. We will role up the above into a function as part of this package so we can easily recalculate for different grid-cell sizes. In the mean-time, let's use `dplyr` to calculate the proportion of fixing legume species in each grid-cell.

```{r map_fixation}
fix_prop_grid <- legume_grid %>%
  mutate(fixing = ifelse(Data_fixing == "Yes", 1, 0)) %>% 
  group_by(grid_id, Species) %>%
  summarise(fix_species = mean(fixing)) %>%
  group_by(grid_id) %>%
  summarise(fix_species = sum(fix_species), tot_species = n()) %>%
  mutate(prop_fix = fix_species / tot_species)
fix_prop_grid
```

Next, we generate polygons for each grid-cell and assign the nitrogen fixing proportion to the appropriate polygon. Then we can plot with `ggplot2`.

```{r draw_map, fig.width=9}
## make polygons
grid_poly <- fortify(as.SpatialPolygons.GridTopology(grid)) %>%
  select(long = lat, lat = long, order, group) %>%
  mutate(grid_id = group)
levels(grid_poly$grid_id) <- levels(grid_poly$grid_id) %>% seq_along
grid_poly <- grid_poly %>% mutate(grid_id = grid_id %>% as.character %>% as.integer)
## check the grid
p <- ggplot(grid_poly, aes(x = long, y = lat, group = grid_id)) + geom_path()
p

fix_prop_grid <- grid_poly %>% inner_join(fix_prop_grid)
world_map <- map_data("world")
library(scales)
p <- ggplot(fix_prop_grid, aes(x = long, y = lat, group = grid_id)) +
  geom_polygon(data = world_map, aes(x = long, y = lat, group = group), size = 0, fill = "grey50") +
  geom_polygon(aes(fill = prop_fix)) +
  geom_path(data = world_map, aes(x = long, y = lat, group = group), colour = "black") +
  theme(panel.background = element_rect(fill="black")) +
  scale_fill_gradient2(low = muted("red"), mid = "white", high = muted("blue"), midpoint = 0.5,
    space = "rgb", na.value = "grey50", guide = "colourbar") + coord_equal()
p
```

For the above figure it would be good to mask out the areas in the ocean. And find a better projection too. We will use the 'Robinson' projection. Also, we will exclude any grid-cells with fewer than 5 data points as unreliable.

```{r robinson}
set_ll_warn(TRUE)
robin_grid <- SpatialPoints(fix_prop_grid %>% select(long, lat), CRS("+proj=longlat +ellps=WGS84")) %>% spTransform(CRS("+proj=robin +ellps=WGS84")) %>% coordinates
fix_prop_grid <- fix_prop_grid %>% mutate(long_robin = robin_grid[ , 1], lat_robin = robin_grid[ , 2], 
                                          rel_fix = ifelse(tot_species < 5, NA, prop_fix)) 
## load Natural Earth map data
world_map <- readOGR(dsn = "/home/annarussell/GeoData/Natural_Earth/50m", layer = "ne_50m_land")
ocean_poly <- readOGR(dsn = "/home/annarussell/GeoData/Natural_Earth/50m", layer = "ne_50m_ocean")
grats <- readOGR(dsn = "/home/annarussell/GeoData/Natural_Earth/50m", layer = "ne_50m_graticules_20")
wmap_df_robin <- spTransform(world_map, CRS("+proj=robin")) %>% fortify
ocean_df_robin <- spTransform(ocean_poly, CRS("+proj=robin")) %>% fortify
grats_df_robin <- spTransform(grats, CRS("+proj=robin")) %>% fortify

## convert grid-cells back to SpatialPolygons
grid_polys <- fix_prop_grid %>% group_by(grid_id) %>% 
  do(poly = Polygon(as.matrix(select(., long, lat)))) %>%
  do(polys = Polygons(list(.$poly), .$grid_id))

sp_grid_polys <- SpatialPolygons(grid_polys$poly, proj4string = CRS("+proj=longlat"))

## calculate intersection
library(rgeos)
library(tidyr)
sp_intersect <- gIntersection(sp_grid_polys, world_map, byid = TRUE)
new_grid <- spTransform(sp_intersect, CRS("+proj=robin")) %>% fortify %>%
  separate(id, c("grid_id", "poly2"), " ", convert = TRUE) %>% 
  left_join(fix_prop_grid %>% select(grid_id, rel_fix))
```

Now to plot the new map!

```{r robinson_map, fig.width=10}
theme_opts <- list(theme(panel.grid.minor = element_blank(),
                        panel.grid.major = element_blank(),
                        panel.background = element_blank(),
                        plot.background = element_rect(fill="grey80"),
                        panel.border = element_blank(),
                        axis.line = element_blank(),
                        axis.text.x = element_blank(),
                        axis.text.y = element_blank(),
                        axis.ticks = element_blank(),
                        axis.title.x = element_blank(),
                        axis.title.y = element_blank(),
                        plot.title = element_text(size=22)))

p <- ggplot(new_grid, aes(x = long, y = lat, group = group)) +
  geom_polygon(data = ocean_df_robin, aes(long, lat, group = group), fill = "#0066CC") +
  geom_path(data = grats_df_robin, aes(long, lat, group = group), colour = "white") +
  geom_polygon(data = wmap_df_robin, aes(x = long, y = lat, group = group), size = 0, fill = "grey20") +
  geom_polygon(aes(fill = rel_fix)) +
  geom_path(data = wmap_df_robin, aes(x = long, y = lat, group = group), colour = "black", size = 0.2) +
  theme_opts +
  scale_fill_gradient(low = "white", high = "darkgreen", na.value = NA, name = "Proportion of\nNitrogen-fixing\nLegume Species") +
  coord_equal()
p
```

Let's make a large high-res map:

```{r high_res}
pdf(file = "Maps/NfixMap_Global.pdf", width = 30, height = 20)
p
dev.off()
```
