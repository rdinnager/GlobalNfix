---
title: "Mapping Nitrogen Fixation Globally"
author: "Russell Dinnage and Anna Simonsen"
date: "06/08/2014"
output: html_document
---

```{r knitr_init, echo=FALSE, results="asis", cache=FALSE}
library(knitr)

## Global options
options(max.print="75")
opts_chunk$set(fig.path="out/",
               echo=TRUE,
         cache=TRUE,
               cache.path="cache/",
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

In this document, we will create a global map, with gridded values representing the proportion of occurring legume species that are nitrogen fixing. First we load the global occurrence data and then create a an overlaying grid, which we can use to aggregate the occurrence data over. Here, we use a mixture of spatial analysis functions from the `sp` package and data.frame manipulation functions of `dply` (to speed up calculations).

```{r grid_it}
library(GlobalNfix)
library(sp)
library(maps)
library(mapdata)
library(maptools)
library(rgdal)
library(ggplot2)
library(dplyr)
library(magrittr)
data(full_legume_data)
## convert to spatial object
## create grid of 5 degrees across globe (we can try other grid sizes as well)
grid <- GridTopology(c(-87.5, -177.5), c(5, 5), c(36, 72))
sp_grid <- coordinates(grid) 
sp_grid <- sp_grid %>% 
  data.frame %>% 
  set_names(c("lat_centre", "long_centre")) %>% 
  mutate(grid_id = seq_len(nrow(sp_grid)))
## assign points to grid
sp_grid_assign <- getGridIndex(cc = full_legume_data %>% 
                                   select(decimalLatitude, decimalLongitude) %>%
                                   data.frame,
                                 grid = grid, all.inside = FALSE)
legume_grid <- full_legume_data %>%
  mutate(grid_id = sp_grid_assign) %>%
  left_join(sp_grid)
```

Now that we have that, we can use `dplyr` to calculate the proportion of nitrogen fixing and non-fixing legumes in each grid-cell. We will role up the above into a function as part of this package so we can easily recalculate for different grid-cell sizes. In the mean-time, let's use `dplyr` to calculate the proportion of fixing legume species in each grid-cell.

```{r map_fixation}
fix_prop_grid <- legume_grid %>%
  mutate(fixing = ifelse(Data_fixing == "Yes", 1, 0)) %>% 
  group_by(grid_id, Species) %>%
  summarise(fix_species = mean(fixing)) %>%
  group_by(grid_id) %>%
  summarise(fix_species = sum(fix_species), tot_species = n()) %>%
  mutate(prop_fix = fix_species / tot_species)
fix_prop_grid
```

Next, we generate polygons for each grid-cell and assign the nitrogen fixing proportion to the appropriate polygon. Then we can plot with `ggplot2`.

```{r draw_map, fig.width=9}
## make polygons
grid_poly <- fortify(as.SpatialPolygons.GridTopology(grid)) %>%
  select(long = lat, lat = long, order, group) %>%
  mutate(grid_id = group)
levels(grid_poly$grid_id) <- levels(grid_poly$grid_id) %>% seq_along
grid_poly <- grid_poly %>% mutate(grid_id = grid_id %>% as.character %>% as.integer)
## check the grid
p <- ggplot(grid_poly, aes(x = long, y = lat, group = grid_id)) + geom_path()
p

fix_prop_grid <- grid_poly %>% inner_join(fix_prop_grid)
world_map <- map_data("worldHires")
library(scales)
p <- ggplot(fix_prop_grid, aes(x = long, y = lat, group = grid_id)) +
  geom_polygon(data = world_map, aes(x = long, y = lat, group = group), size = 0, fill = "grey50") +
  geom_polygon(aes(fill = prop_fix)) +
  geom_path(data = world_map, aes(x = long, y = lat, group = group), colour = "black") +
  theme(panel.background = element_rect(fill="black")) +
  scale_fill_gradient2(low = muted("red"), mid = "white", high = muted("blue"), midpoint = 0.5,
    space = "rgb", na.value = "grey50", guide = "colourbar") + coord_equal()
p
```

For the above figure it would be good to mask out the areas in the ocean. And find a better projection too.

```{r robinson, eval = FALSE}
set_ll_warn(TRUE)
set_ll_TOL(0.1)
world_map_2 <- map("worldHires", plot = FALSE, fill = TRUE, xlim = c(-180, 180))
world_poly <- map2SpatialPolygons(world_map_2, IDs=world_map_2$names, proj4string = CRS("+proj=longlat +ellps=WGS84"))
wmap_robin <- spTransform(world_poly, CRS("+proj=robin +ellps=WGS84"))
ggworld <- fortify(wmap_robin)
mappy <- ggplot(ggworld, aes(long, lat, group = group)) + geom_polygon() + coord_equal()
mappy
mappy <- ggplot(world_poly, aes(long, lat, group = group)) + geom_polygon() + coord_equal()
mappy
```
