---
title: "Preliminary Latitude Analysis"
author: "Russell Dinnage and Anna Simonsen"
date: "Saturday, August 02, 2014"
output: 
  html_document:
    highlight: pygments
---

```{r knitr_init, echo=FALSE, results="asis", cache=FALSE}
library(knitr)

## Global options
options(max.print="75")
opts_chunk$set(fig.path="out/",
               echo=TRUE,
         cache=TRUE,
               cache.path="cache/",
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

Here we will document a preliminary analysis of GBIF data and nitrogen fixation data on legumes. The first step is to load our data and then generate latitude data by species. In this initial analysis we will simply use the median latitude of all GBIF records for each species.

```{r load_agg}
library(GlobalNfix)
library(dplyr)
data(full_legume_data)
full_legume_data <- full_legume_data %>% tbl_df
full_legume_data
legume_dat <- full_legume_data %>% 
  mutate(fixing = ifelse(Data_fixing == "Yes", 1, 0)) %>%
  group_by(Species) %>% 
  summarise(median_lat = median(decimalLatitude), 
            median_long = median(decimalLongitude), 
            fixer = mean(fixing))
legume_dat
```

As a first basic analysis, we will run a logistic regression with nitrogen fixation as the response variable, and absolute median latitude as the predictor variable.

```{r log_reg}
library(ggplot2)
leg_mod <- glm(fixer~scale(abs(median_lat), scale = FALSE)*median_long, data = legume_dat, family = binomial())
summary(leg_mod)
```

The model suggests a positive relationship between absolute median latitude and the probability that a species will fix nitrogen within the legumes. It also suggests that the relationship varies by longitude such that the further East we go, the stronger the latitudinal effect. This could be caused by the fact that we have few data points for China and Russia, and so the Eastern side of the analysis will be dominated by the equator through Australia to New Zealand effect, whereas in the West, the relationship will be more indicative of equator through North America to Alaska, and the equator through Europe effects (because we have tons of points in Europe and North America. Let's plot the relationship by latitude:

```{r plot_it, dev='svg'}
##Plot it!
p <- ggplot(legume_dat, aes(median_lat, fixer)) + geom_point(alpha=0.25, position = position_jitter(width = 0, height = 0.1)) + stat_smooth(color = "black", size = 1.0) + theme_bw()
p
```

There is a prominant dip in nitrogen fixation at the equator (down to about 70% nitrogen fixation), and a gradual increase towards the two poles. After about to 40 degrees latitude or so, all legumes are fixers. Frankly we were surprised by how smooth and symmetrical the relationship is, despite large variation in sample size across the latitudinal gradient.  

At least in this preliminary analysis, it appears that there is indeed a fairly strong pattern of nitrogen fixation with latitude. There are several issues we need to try and account for to make sure this is robust, of course. One is dealing with error in the database (this analysis uses the whole database not just the part that has been corrected). Another is the issue of introduced species. GBIF makes not distinction between native or introduced. We are hoping we can deal with this by looking at the native vs. introduced status of legume species as recorded in the ILDIS database. In most cases, we would imagine that introduced species' latitudinal range will be fairly similar to their latitudinal range in their native region, at least with respect to the entire globe, and so hopefully this factor won't lead to much of a bias in the results.

## Error Analysis

Let's have a look at how errors in the checked part of the nitrogen fixation data are distributed.

```{r error_check, dev='svg'}
error_checked <- full_legume_data %>% filter(Analysed_Werner_etal. == "Analysed")
error_dat <- error_checked %>% 
  mutate(fixing = ifelse(Data_fixing == "Yes", 1, 0)) %>%
  group_by(Species) %>% 
  summarise(median_lat = median(decimalLatitude), 
            median_long = median(decimalLongitude), 
            fixer = mean(fixing),
            corrected = Data_corrected[1])
corrected_dat <- error_dat %>% filter(corrected == "Data_corrected") %>% 
  mutate(correction_direction = ifelse(fixer == 1, 1, -1))
p <- ggplot(corrected_dat, aes(median_lat, correction_direction)) + geom_point() + stat_smooth(color = "black", size = 1.0) + theme_bw()
p
```

In the above figure, a 1 on the y axis means a non-fixer was corrected to a fixer in the database. A -1 means a fixer was corrected to a non-fixer. Overall, there were more errors recording a non-fixer as a fixer. This suggests that in the full database, non-fixers are probably under-estimated. There does not appear to be any patterns in the error direction with latitude, meaning that our results are unlikely to be explained by errors in the database (assuming errors in the unchecked part of the database are distributed similarly to those in the checked part).

There were no errors for species more than 40 degrees above or below the equator. So we can say there is an increase in the number of errors in the tropics. Since most errors were recording non-fixers as fixers, this means that the full database likely slighly under-estimates the number of non-fixers in the tropics, as compared with temperate regions. So, if anything, the pattern we detected may actually be stronger than we are able to show (e.g. our results are conservative).

##Phylogenetic analysis

Now, we will see if the latitudinal regression holds when we control for phylogeny. If the effect goes away, it implies that the effect is largely driven by radiations of non-nitrogen-fixing in the tropics (since we assume that the legume common ancestor was nitrogen-fixing). This mean it could be because lineages which happened to not fix nitrogen were successful for some other reason, and the diversification of these clades dragged the nitrogen non-fixing trait along (non-adaptive explanation). Or it could be those lineages diversified because they were non-fixing (adaptive explanation). It would be difficult to distinguish these two hypotheses in this case.  First, let's load up the phylogeny.

```{r load_phylo}
library(ape)
big_tree <- system.file("extdata/Vascular_Plants_rooted.dated.tre", package = "GlobalNfix") %>% read.tree
legume_specs <- big_tree$tip.label %in% sub(" ", "_", legume_dat$Species)
## how many legumes are in the phylogeny?
sum(legume_specs)
legume_tree <- drop.tip(big_tree, which(!legume_specs))
plot(legume_tree, type = "f", cex = 0.3)
```

Now we can repeat the latitudinal logistic regression using phylogenetic logistic regression, on only the species that occur in the phylogeny. We will use the `phylolm` package to conduct the phylogenetic logistic regression (which runs the type of model described in Ives and Garland 2010).

```{r phylo_reg, warning=TRUE}
library(magrittr)
library(phylolm)
leg_dat <- legume_dat %>% data.frame %>%
  set_rownames(legume_dat$Species %>% sub(" ", "_", .))
leg_dat <- leg_dat[rownames(leg_dat) %in% legume_tree$tip.label, ]
phy_mod <- phyloglm(fixer~abs(median_lat), data = leg_dat, phy = legume_tree, method = "MPLE", btol = 60)
summary(phy_mod)
#phy_mod <- phyloglm(fixer~scale(median_lat, scale = FALSE)*scale(median_long, scale = FALSE), data = #leg_dat, phy = legume_tree, method = "MPLE", btol = 100, start.alpha = 0.01)
#summary(phy_mod)
test_lm <- lm(fixer~abs(median_lat), data = leg_dat)
summary(test_lm)
phy_mod <- phylolm(fixer~abs(median_lat), data = leg_dat, phy = legume_tree)
summary(phy_mod)
```

Well, so far I can't seem to get the phylogenetic logistic regression (`phyloglm`) model to converge. However, with a large dataset like this, a regular egression usually gives a pretty similar answer to a logistic regression (thank you central limit theorem). Using just regular regression, we can see that the latitudinal effect holds for the species that are in the phylogeny, but when we do a phylogenetic regression, the effect goes away (in fact the trend reverses, becoming slightly negative, though not significantly so).

##Woody vs. Non-woody Legumes

The next step will be to create a global map of proportional nitrogen fixation, so we can see any other geographic patterns that emerge.
